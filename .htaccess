# Set default index file
DirectoryIndex index.php index.html

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # IMPORTANT: Block direct access to config, includes, backups folders FIRST
    # This pattern matches /config/, /includes/, /backups/ anywhere in the URL
    RewriteCond %{REQUEST_URI} /(config|includes|backups)(/|$) [NC]
    RewriteRule ^(.*)$ - [F,L]
    
    # Skip rewrite for assets and API (allow access)
    RewriteCond %{REQUEST_URI} \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|pdf|zip)$ [OR]
    RewriteCond %{REQUEST_URI} /(assets|api)/ [NC]
    RewriteRule ^ - [L]
    
    # Skip rewrite for existing files (but not config/includes/backups)
    # Allow direct access to PHP files, but route clean URLs through router
    RewriteCond %{REQUEST_URI} !/(config|includes|backups)(/|$) [NC]
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^ - [L]
    
    # Skip rewrite for existing directories (but not config/includes/backups)
    RewriteCond %{REQUEST_URI} !/(config|includes|backups)(/|$) [NC]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]
    
    # Route all other requests (including root and clean URLs) to router.php
    RewriteRule ^(.*)$ router.php [L,QSA]
</IfModule>

# Fallback: If mod_rewrite is not available, ensure index.php is loaded for root
<IfModule !mod_rewrite.c>
    # This is a fallback - mod_rewrite should be enabled for full functionality
    # Root requests will use DirectoryIndex (index.php) automatically
</IfModule>

# Prevent directory listing
Options -Indexes

# Security - Block access to sensitive file types
<FilesMatch "\.(sql|log|ini|conf|env)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

# Block direct access to config files (if accessed directly)
<FilesMatch "^(config|database|ai_config)\.php$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>
